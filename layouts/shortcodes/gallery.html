{{/* layouts/shortcodes/gallery.html */}}
{{/* This shortcode creates a responsive image gallery with a lightbox. */}}
{{/* Usage:
    {{< gallery >}}
    /images/image1.jpg
    https://example.com/remote-image.png
    /assets/img/another-image.webp
    {{< /gallery >}}
*/}}

{{- $galleryId := printf "gallery-%s" (substr (md5 .Inner) 0 8) -}} {{/* Generate a somewhat unique ID for the gallery based on its content. Used for grouping lightbox items. */}}
{{- $imageSources := split .Inner "\n" -}} {{/* Split inner content by newlines to get image sources (URLs or local paths). */}}
{{- $currentPage := .Page -}} {{/* Store the current page context to safely use it in warnf. */}}

<div class="image-gallery" id="{{ $galleryId }}">
    {{- range $index, $rawSource := $imageSources -}}
        {{- $source := strings.TrimSpace $rawSource -}} {{/* Trim whitespace from the source string. */}}
        {{- if $source -}} {{/* Process only if the source string is not empty. */}}
            {{- $caption := "" -}}
            {{- $thumbnailUrl := "" -}}
            {{- $fullImageUrl := "" -}}
            {{- $isRemote := or (strings.HasPrefix $source "http://") (strings.HasPrefix $source "https://") -}} {{/* Check if the source is a remote URL. */}}
            {{- $isStatic := and (not $isRemote) (strings.HasPrefix $source "/") -}} {{/* Check if it's a path to a static file (starts with / but not http/s). */}}

            {{- if $isRemote -}}
                {{- $fullImageUrl = $source -}}
                {{- $thumbnailUrl = $source -}} {{/* For remote images, thumbnail is the same as full. CSS will handle display. */}}
                {{- $filename := path.Base $source -}} {{/* Extract filename from URL (e.g., image.jpg?query). */}}
                {{- $cleanedFilename := index (strings.Split $filename "?") 0 -}} {{/* Get the part of the filename before the first '?' */}}
                {{- $caption = strings.TrimSuffix (path.Ext $cleanedFilename) $cleanedFilename -}} {{/* Get filename without extension for the caption. */}}
            {{- else if $isStatic -}}
                {{- $fullImageUrl = ($source | relURL) -}} {{/* For static files, generate a site-relative URL. */}}
                {{- $thumbnailUrl = $fullImageUrl -}} {{/* Static files use original as thumbnail, like remote. CSS handles display. */}}
                {{- $filename := path.Base $source -}} {{/* Extract filename from path. */}}
                {{- $caption = strings.TrimSuffix (path.Ext $filename) $filename -}} {{/* Get filename without extension for the caption. */}}
            {{- else -}} {{/* Otherwise, assume it's an asset path for processing. */}}
                {{- $imageResource := resources.Get $source -}} {{/* Get the image resource from /assets or page resources. */}}
                {{- if $imageResource -}}
                    {{- $thumbnail := $imageResource.Fill "300x300 Smart" -}} {{/* Create a 300x300 smart cropped thumbnail. */}}
                    {{- $thumbnailUrl = $thumbnail.RelPermalink -}}
                    {{- $fullImageUrl = $imageResource.RelPermalink -}}
                    {{- $filename := $imageResource.Name -}} {{/* Get the original filename (e.g., my-image.jpg). */}}
                    {{- $caption = strings.TrimSuffix (path.Ext $filename) $filename -}} {{/* Get filename without extension for the caption. */}}
                {{- else -}}
                    {{- warnf "Image gallery: Asset resource not found for path: '%s' in page '%s'. If this is a static file (e.g., in /static/images/), prefix the path with a '/' like '/images/myimage.jpg'." $source $currentPage.Path -}}
                {{- end -}}
            {{- end -}}

            {{- if $fullImageUrl -}}
            {{/* Each gallery item is a link to the full image, displaying a thumbnail. */}}
            <a href="{{ $fullImageUrl }}" class="gallery-item" data-lightbox-group="{{ $galleryId }}" data-title="{{ $caption | default "Image" | humanize | title }}">
                <img src="{{ $thumbnailUrl }}" alt="{{ $caption | default (printf "Gallery image %d" (add $index 1)) }}" width="300" height="300" loading="lazy">
                {{/* The caption is displayed over the image (styling controlled by CSS). */}}
                <div class="gallery-item-caption">{{ $caption | default "Image" | humanize | title }}</div>
            </a>
            {{- end -}}
        {{- end -}}
    {{- end -}}
</div>