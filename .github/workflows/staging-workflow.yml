# Main Workflow
# Trigger on every commit to staging
name: Action on push to staging
on:
  push:
    branches:
      - staging
  pull_request:
    branches:
      - staging
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for all branches

      - name: Configure Git
        run: |
          git config user.name "1bl4z3r"
          git config user.email "34515568+1bl4z3r@users.noreply.github.com"
      
      - name: Fetch all branches
        run: |
          git fetch origin staging
          git fetch origin main
      
      - name: Capture commit message from staging
        run: |
          # Switch to staging branch
          git checkout staging
          git pull origin staging
          
          # Capture the full commit message using heredoc syntax for multiline support
          echo 'COMMIT_MESSAGE<<EOF' >> $GITHUB_ENV
          git log -1 --pretty=%B >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
      
      - name: Generate list of files to sync from staging
        run: |
          # Find all files in staging, excluding ignored patterns
          # This list represents what should exist in main after sync
          git ls-files | grep -v \
            -e '^resources/' \
            -e '^\.git/' \
            -e '^\.github/' \
            -e '^static/' \
            -e '^content/' \
            -e '^public/' \
            -e '^assets/custom_css/' \
            -e '^assets/custom_js/' \
            -e '^assets/images/' \
            -e '^i18n/' \
            -e '^hugo\.toml$' \
            -e '/928-600x400\.jpg$' \
            -e '/images/favicon\.svg$' \
            -e '^hugo_build\.lock$' \
            -e '/hermit\.webp$' \
            -e '^\.gitignore$' \
            > /tmp/files_to_sync.txt || true
          
          # Ensure hugo.toml.example is included if it exists
          if git ls-files | grep -q '^hugo\.toml\.example$'; then
            echo "hugo.toml.example" >> /tmp/files_to_sync.txt
          fi
          
          echo "Files to sync from staging to main:"
          cat /tmp/files_to_sync.txt
      
      - name: Sync main branch with staging (selective)
        run: |
          # Switch to main branch
          git checkout main
          git pull origin main
          
          # Step 1: Remove all non-ignored files from main
          # This handles deletions and moves (old locations get cleaned up)
          echo "Removing existing non-ignored files from main..."
          git ls-files | grep -v \
            -e '^resources/' \
            -e '^\.git/' \
            -e '^\.github/' \
            -e '^static/' \
            -e '^content/' \
            -e '^public/' \
            -e '^assets/custom_css/' \
            -e '^assets/custom_js/' \
            -e '^assets/images/' \
            -e '^i18n/' \
            -e '^hugo\.toml$' \
            -e '/928-600x400\.jpg$' \
            -e '/images/favicon\.svg$' \
            -e '^hugo_build\.lock$' \
            -e '/hermit\.webp$' \
            -e '^\.gitignore$' \
            | xargs -r git rm -f --quiet || true
          
          # Step 2: Copy all files from staging that should be synced
          echo "Copying files from staging..."
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              # Create directory if it doesn't exist
              mkdir -p "$(dirname "$file")"
              
              # Copy the file from staging branch
              git checkout staging -- "$file" 2>/dev/null || echo "Warning: Could not checkout $file"
            fi
          done < /tmp/files_to_sync.txt
          
          # Stage all changes
          git add -A
          
          echo "Sync complete. Summary of changes:"
          git status --short
      
      - name: Commit and push changes
        run: |
          # Check if there are any changes to commit
          if git diff --cached --quiet; then
            echo "No changes to sync - main already matches staging"
          else
            # Commit with the original message from staging
            git commit -m "$COMMIT_MESSAGE" || git commit -m "Sync changes from staging to main"
            
            # Push the changes
            git push origin main
            echo "Changes successfully synced from staging to main"
          fi
      
      - name: Clean up
        if: always()
        run: |
          rm -f /tmp/files_to_sync.txt
  
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"

  build-and-deploy-site:
    name: Build and Deploy Hugo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true
      - name: Build site with Hugo
        run: hugo --minify --noBuildLock --ignoreCache --gc --logLevel debug && cp public/en/404.html public/404.html
      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages